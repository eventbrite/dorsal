/**
 * @license
 * Copyright 2014 Eventbrite
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 *
 * You may obtain a copy of the License at
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/*! dorsal - v0.4.0 - 2014-10-01 */
!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define([],b):a.Dorsal=b()}(this,function(){function a(a,b){var c=a.length,d=0;if(a.indexOf)return a.indexOf(b);for(;c>d;d++)if(a[d]===b)return d;return-1}var b=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}(),c=function(){};c.prototype.VERSION="0.4.0",c.prototype.CSS_PREFIX=".js-d-",c.prototype.DATA_IGNORE_PREFIX="xd",c.prototype.DATA_PREFIX="d",c.prototype.DATA_DORSAL_WIRED="data-"+c.prototype.DATA_IGNORE_PREFIX+"-wired",c.prototype.GUID_KEY="dorsal-guid",c.prototype.ELEMENT_TO_PLUGINS_MAP={},c.prototype.registerPlugin=function(a,b){this.plugins||(this.plugins={}),this.plugins[a]=b},c.prototype.unregisterPlugin=function(a){delete this.plugins[a]},c.prototype._getDatasetAttributes=function(a){var b=a.dataset,c={};for(var d in b)if(new RegExp("^"+this.DATA_PREFIX+"[A-Z]").test(d)){var e=d.substr(this.DATA_PREFIX.length),f=e[0].toLowerCase()+e.substr(1);c[f]=b[d]}return c},c.prototype._normalizeDataAttribute=function(a){return a.toUpperCase().replace("-","")},c.prototype._getDataAttributes=function(a){var b={},c=a.attributes,d=c.length,e="name",f=0;for(f=0;d>f;f++)if(new RegExp("^data-"+this.DATA_PREFIX+"-").test(c[f][e])){var g=c[f][e].substr(5+this.DATA_PREFIX.length+1).toLowerCase().replace(/(\-[a-zA-Z])/g,this._normalizeDataAttribute);b[g]=c[f].value}return b},c.prototype._getAttributes=function(a){return a.dataset?this._getDatasetAttributes(a):this._getDataAttributes(a)},c.prototype._runPlugin=function(a,c){if(a.getAttribute(this.DATA_DORSAL_WIRED)&&-1!==a.getAttribute(this.DATA_DORSAL_WIRED).indexOf(c))return!1;var d=this._getAttributes(a),e=a.getAttribute(this.DATA_DORSAL_WIRED),f=this.plugins[c],g={el:a,data:d},h=a.getAttribute(this.GUID_KEY);h||(h=b(),a.setAttribute(this.GUID_KEY,h),this.ELEMENT_TO_PLUGINS_MAP[h]={}),"function"==typeof f?this.ELEMENT_TO_PLUGINS_MAP[h][c]=f.call(a,g):"object"==typeof f&&(this.ELEMENT_TO_PLUGINS_MAP[h][c]=f.create.call(a,g)),e?a.setAttribute(this.DATA_DORSAL_WIRED,e+" "+c):a.setAttribute(this.DATA_DORSAL_WIRED,c)},c.prototype._wireElement=function(a,b,c){var d=this;window.setTimeout(function(){var e,f,g=d.CSS_PREFIX+b,h=void 0!==a&&a.querySelectorAll;if(h){e=a.querySelectorAll(g),a!==document&&a.className.indexOf(g.substr(1))>-1&&(f=d._runPlugin(a,b),c.notify(b,f,d));for(var i,j=0;i=e[j];j++)f=d._runPlugin(i,b),c.notify(b,f,d)}},0)},c.prototype._detachPlugin=function(b,d){var e,f=!1;return"string"!=typeof b.getAttribute(this.DATA_DORSAL_WIRED)?!1:(b.getAttribute(this.DATA_DORSAL_WIRED).indexOf(d)>-1&&this.plugins[d].destroy&&(this.plugins[d].destroy({el:b,data:this._getAttributes(b),instance:this.ELEMENT_TO_PLUGINS_MAP[b.getAttribute(c.prototype.GUID_KEY)][d]}),f=!0),e=b.getAttribute(this.DATA_DORSAL_WIRED).split(" "),e.splice(a(e,d),1),b.setAttribute(this.DATA_DORSAL_WIRED,e.join(" ")),f)},c.prototype.unwire=function(a,b){if(b)return this._detachPlugin(a,b);for(var c,d=a.getAttribute(this.DATA_DORSAL_WIRED).split(" "),e=d.length,f=!1,g=0;e>g;g++)c=d[g],this._detachPlugin(a,c)&&(f=!0);return f},c.prototype.wire=function(a,b){var c=new DorsalDeferred(this),d=Object.keys(this.plugins),e=void 0!==b?1:d.length,f=0;if(c.promise().progress(function(){f++,f===e&&c.resolve()}),!this.plugins)throw new Error("No plugins registered with Dorsal");if(b)return this._wireElement(a,[b],c),c.promise();for(var g=0,h=d.length,a=a||document;h>g;g++)this._wireElement(a,d[g],c);return c.promise()},c.prototype.rewire=function(a,b){return this.unwire(a,b),this.wire(a,b)};var d=new c;return d.create=function(){return new c},DorsalDeferred=function(a){var b,c="pending",d=[],e=[],f=[],g=this;return b={state:function(){return g.state()},done:function(b){return"resolved"===c&&b.call(g,a),d.push(b),g},fail:function(b){return"rejected"===c&&b.call(g,a),e.push(b),g},progress:function(a){return f.push(a),g}},g.state=function(){return c},g.notify=function(){var a,b=f.length;for(a=0;b>a;a++)f[a].apply(g,arguments)},g.reject=function(){var b,d=e.length;for(c="rejected",b=0;d>b;b++)e[b].call(g,a)},g.resolve=function(){var b,e=d.length;for(c="resolved",b=0;e>b;b++)d[b].call(g,a)},g.promise=function(){return b},g},d});